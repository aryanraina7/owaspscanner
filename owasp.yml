# OWASP Scanning Pipeline Without Daemon

trigger:
- main # Adjust the branch as needed

pool:
  vmImage: 'ubuntu-latest' # Microsoft-hosted Ubuntu agent

stages:
- stage: OWASP_ZAP_Scan
  displayName: OWASP ZAP Security Scan
  jobs:
  - job: OWASP_ZAP_Scan_Job
    displayName: OWASP ZAP Scan Job
    steps:

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
        addToPath: true

    - script: |
        python -m pip install --upgrade pip
        pip install python-owasp-zap-v2.4  # Install OWASP ZAP Python API
      displayName: 'Install OWASP ZAP Python API'
    
    - script: |
        # Run ZAP scan using Docker
        docker run --rm -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-full-scan.py -t http://your-target-url.com -x zap_report.xml
      displayName: 'Run OWASP ZAP Scan'
    
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(System.DefaultWorkingDirectory)/zap_report.xml'
        artifactName: 'ZAPReport'
      displayName: 'Publish OWASP ZAP Report'

    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/zap_report.xml'
        failTaskOnFailedTests: true
      displayName: 'Publish Test Results'

- stage: Review_Report
  displayName: Review ZAP Report
  dependsOn: OWASP_ZAP_Scan
  jobs:
  - job: Review_Report_Job
    displayName: Review Report Job
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        artifactName: 'ZAPReport'
        downloadPath: '$(System.DefaultWorkingDirectory)'
      displayName: 'Download ZAP Report'

    - script: |
        # Review or take further actions on the ZAP report if needed
        echo "OWASP ZAP Report downloaded"
      displayName: 'Review ZAP Report'
